<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>COOU App UI</title>
  <link rel="stylesheet" href="./css/dashboard.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

</head>
<body>
<!-- âœ… Top Header -->
<header class="top-header">
  <div class="logo">COOU</div>

  <!-- âœ… Profile Trigger (clickable area) -->
  <div class="profile-trigger" id="toggle-profile">
    <span id="username">IFESINACHI</span>
    <img class="nav-profile-img" src="https://i.postimg.cc/FKRrnLbg/coou-connect-logo.jpg" alt="Profile" />
  </div>
</header>

<!-- âœ… Dropdown Profile Panel -->
<div id="profile-section" class="profile-dropdown" style="display: none;">
  <div id="profile-view" class="profile-card">
    <img id="profile-photo" src="https://i.postimg.cc/FKRrnLbg/coou-connect-logo.jpg" alt="Profile" />
    <h3 id="view-name">Full Name</h3>
    <p id="view-dept">Department</p>
    <p id="view-level">Level</p>
    <button id="edit-profile-btn">Edit Profile</button>
    <button id="signout-btn" class="signout-btn">Sign Out</button>
  </div>

  <div id="profile-edit" style="display: none;">
    <form id="edit-profile-form">
      <input type="text" id="edit-name" placeholder="Full Name" />
      <input type="text" id="edit-dept" placeholder="Department" />
      <input type="text" id="edit-level" placeholder="Level" />
      <input type="file" id="edit-image" />
      <button type="submit">Save</button>
      <button type="button" id="cancel-edit">Cancel</button>
    </form>
    <div id="upload-loader" class="loader-text" style="display: none;">Uploading...</div>
  </div>
</div>





  <main id="content">
   <div id="feed-upload" class="feed-upload-card">
  <h3>Create a Post</h3>
  <form id="post-form">
    <textarea id="post-caption" placeholder="What's on your mind?" required></textarea>
    <input type="file" id="post-image" accept="image/*" />
    <button type="submit">Post</button>
    <p id="post-loader" class="loader-text" style="display: none;">Uploading...</p>
  </form>
</div>
<button id="enable-notifs">Enable Notifications</button>
<!-- Feed Posts Container -->
 <div id="feeds-container"></div>

<div id="post-feed" class="feed-container"></div>
<br><br>
<div id="like-modal" class="like-modal" style="display: none;">
  <div class="like-modal-content">
    <h3>Liked By</h3>
    <ul id="like-user-list"></ul>
    <button id="close-like-modal">Close</button>
  </div>
</div>
<div class="comment-section">
  <div class="comment-list">
    <!-- comment-item(s) injected here -->
  </div>
</div>


<p id="auth-error" class="error-text" style="display: none; color: red;"></p>



  </main>
  <div id="nav-placeholder"></div>

  <script>
    // Load nav.html into placeholder
    fetch("nav.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("nav-placeholder").innerHTML = html;

        // Highlight active nav
        const current = window.location.pathname;
        document.querySelectorAll(".bottom-nav button").forEach(btn => {
          if (current.includes(btn.id.replace("nav-", ""))) {
            btn.classList.add("active");
          }
        });

        // Navigation routing
        document.querySelector("#nav-home")?.addEventListener("click", () => window.location.href = "dashboard.html");
        document.querySelector("#nav-discover")?.addEventListener("click", () => window.location.href = "discover.html");
        document.querySelector("#nav-trade")?.addEventListener("click", () => window.location.href = "users.html");
        document.querySelector("#nav-friends")?.addEventListener("click", () => window.location.href = "chat.html");
      });
  </script>
  <script type="module" src="./js/dashboard.js" defer></script>
  <script type="module" src="./js/notification.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  (function(){
    emailjs.init("V0eT-aJyyq0_HVaYV"); 
  })();
</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-messaging.js";
  import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

  // âœ… Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyByuuRpHOfeWEcKl_oaob6V_tmnYyJ_vbU",
    authDomain: "coou-connect-75406.firebaseapp.com",
    projectId: "coou-connect-75406",
    storageBucket: "coou-connect-75406.appspot.com",
    messagingSenderId: "1070347911713",
    appId: "1:1070347911713:web:35c75b840a38f6cd7a1960"
  };

  // âœ… Init Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const messaging = getMessaging(app);

  // âœ… Request Notification Permission + Save Token
  async function requestPermissionAndSaveToken(user) {
    try {
      const token = await getToken(messaging, {
        vapidKey: "BOYugWO9mtdXtEdsz4fUssQ6z5A-q2ddDEAtoDcUxgWIhRsLrGOknkt9BGr87KPOzjYn5Y5_HtldmeCP_pQJHGM"
      });

      if (token) {
        console.log("âœ… FCM Token:", token);

        // Save token to Firestore under user's profile
        await setDoc(doc(db, "users", user.uid), { fcmToken: token }, { merge: true });
      } else {
        console.warn("âš ï¸ No registration token available. User might have blocked notifications.");
      }
    } catch (err) {
      console.error("âŒ Error getting token:", err);
    }
  }

  // âœ… Handle Foreground Notifications
  onMessage(messaging, (payload) => {
    console.log("ðŸ“© Message received:", payload);
    alert(`New notification: ${payload.notification.title}`);
  });

  // âœ… Trigger when user logs in
  onAuthStateChanged(auth, (user) => {
    if (user) {
      requestPermissionAndSaveToken(user);
    }
  });
</script>

</body>
</html>
